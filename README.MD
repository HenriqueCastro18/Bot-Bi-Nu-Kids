# Bot de Aluguel de Brinquedos (BI & NU Kids)

Este √© um bot completo para WhatsApp (via Twilio) e Telegram, projetado para gerenciar o aluguel de brinquedos e equipamentos para festas infantis. Ele gerencia todo o fluxo: consulta o cat√°logo, verifica disponibilidade no Google Calendar, calcula frete via Google Maps e processa o pagamento (sinal) com Mercado Pago. Ap√≥s a confirma√ß√£o (webhook), atualiza a agenda e envia um relat√≥rio financeiro por e-mail.

## üì∫ Demonstra√ß√£o em A√ß√£o

Assista aos v√≠deos abaixo para ver as principais funcionalidades do bot em a√ß√£o.

---

### V√≠deo 1: Testando o Fluxo Principal do Bot
*(Demonstra√ß√£o completa do fluxo de reserva no WhatsApp, desde a escolha no cat√°logo, c√°lculo de frete, agendamento no Google Calendar e gera√ß√£o do link de pagamento do Mercado Pago.)*

[![Demonstra√ß√£o do Bot no WhatsApp](https://img.youtube.com/vi/UNsJ8uvj7Y8/0.jpg)](https://www.youtube.com/watch?v=UNsJ8uvj7Y8)

[Link Direto para o V√≠deo 1](https://www.youtube.com/watch?v=UNsJ8uvj7Y8)

---

### V√≠deo 2: Testando o Reagendamento
*(Demonstra√ß√£o da funcionalidade de reagendamento de um evento existente, mostrando a intera√ß√£o do bot com o Google Calendar para alterar a data.)*

[![Demonstra√ß√£o do Bot no Telegram](https://img.youtube.com/vi/6HPeNNPDBmQ/0.jpg)](https://www.youtube.com/watch?v=6HPeNNPDBmQ)

[Link Direto para o V√≠deo 2](https://www.youtube.com/watch?v=6HPeNNPDBmQ)

---

## üöÄ Funcionalidades Principais

* **Multi-Plataforma:** Funciona de forma id√™ntica no **WhatsApp** (via Twilio) e no **Telegram**.
* **Cat√°logo Completo:** Navega√ß√£o por categorias, combos e itens avulsos com imagens, descri√ß√µes e pre√ßos.
* **Agendamento Inteligente:** Integra√ß√£o em tempo real com a API do **Google Calendar** para verificar dias e hor√°rios dispon√≠veis, evitando conflitos de reserva.
* **C√°lculo de Frete:** Integra√ß√£o com a API do **Google Maps** (Distance Matrix) para calcular a dist√¢ncia exata at√© o endere√ßo do cliente e definir o valor do frete.
* **Pagamento de Sinal:** Gera√ß√£o de link de pagamento (50% do valor) via **Mercado Pago SDK**.
* **Confirma√ß√£o Autom√°tica:** O bot usa Webhooks para "ouvir" a confirma√ß√£o do Mercado Pago. Ao receber, ele:
    1.  Atualiza o evento no Google Calendar de "Pendente" para "Confirmado".
    2.  Salva a venda no banco de dados SQLite.
    3.  Avisa o cliente da confirma√ß√£o.
* **Reagendamento:** Permite ao cliente buscar seus eventos futuros (pelo CPF) e solicitar o reagendamento.
* **Sincroniza√ß√£o Financeira:** Ap√≥s uma venda confirmada, o bot automaticamente:
    1.  Atualiza uma planilha **Excel (`.xlsx`)** com todos os dados da venda (custos, faturamento, lucro).
    2.  Envia esta planilha atualizada por **e-mail** (via SMTPLib) para o administrador.
* **Gest√£o de Estado:** Salva o progresso da conversa de cada usu√°rio (carrinho, etapa atual) em um banco de dados SQLite, permitindo que o usu√°rio continue de onde parou.

## üõ†Ô∏è Tecnologias Utilizadas

* **Backend:** Python
* **Servidores Web/API:** Flask, Gunicorn
* **Mensageria:** Twilio (WhatsApp), Python-Telegram-Bot (Telegram)
* **Banco de Dados:** SQLite
* **APIs Externas:**
    * Google Calendar API
    * Google Maps Geocoding & Distance Matrix API
    * Mercado Pago SDK
* **Manipula√ß√£o de Dados:** OpenPyXL (para gerar planilhas Excel)
* **Notifica√ß√£o:** SMTPLib (para envio de e-mail com relat√≥rios)

## üèóÔ∏è Como Funciona (Arquitetura)

Este projeto √© modular e requer 3 servi√ßos principais rodando em paralelo:

1.  **Servidor WhatsApp (`app.py`):** Um servidor Flask que recebe os webhooks da Twilio (mensagens do WhatsApp).
2.  **Servidor de Imagens e Pagamentos (`image_server.py`):** Um segundo servidor Flask que:
    * Serve as imagens dos produtos para o bot (`/image/...`).
    * Recebe os webhooks de confirma√ß√£o do Mercado Pago (`/webhook/mercadopago`).
3.  **Bot do Telegram (`bot_telegram.py`):** Um script que roda em *polling*, conectando-se diretamente √† API do Telegram para ler e enviar mensagens.

O "c√©rebro" do projeto est√° no `logic.py`, que √© chamado tanto pelo `app.py` quanto pelo `bot_telegram.py` para processar as mensagens e manter o estado da conversa.

## üì¶ Instala√ß√£o e Configura√ß√£o

1.  **Clone o reposit√≥rio:**
    ```bash
    git clone [https://github.com/SEU_USUARIO/NOME_DO_REPOSITORIO.git](https://github.com/SEU_USUARIO/NOME_DO_REPOSITORIO.git)
    cd NOME_DO_REPOSITORIO
    ```

2.  **Crie um ambiente virtual e instale as depend√™ncias:**
    ```bash
    python -m venv venv
    source venv/bin/activate  # (No Windows: venv\Scripts\activate)
    pip install -r requirements.txt
    ```

3.  **Configure as Credenciais (Arquivos Ignorados):**
    * **Google:** Crie um projeto no Google Cloud, ative as APIs (Calendar, Maps) e gere um arquivo `credentials.json` de conta de servi√ßo. Coloque-o na raiz do projeto.
    * **Outras Chaves:** Renomeie `config.py.example` para `config.py` e preencha **todas** as chaves (Telegram, Twilio, Mercado Pago, E-mail, etc.).

4.  **Inicialize o Banco de Dados:**
    (Este comando cria o arquivo `financeiro.db` com as tabelas necess√°rias)
    ```bash
    python -c "import database; database.inicializar_banco()"
    ```

## üèÉ Como Rodar (Localmente)

Voc√™ precisar√° de 3 (ou 4) terminais abertos para rodar o projeto localmente.

1.  **Terminal 1: Servidor de Imagens e Pagamentos**
    (Este servidor serve as imagens e ouve o Mercado Pago)
    ```bash
    # (Por padr√£o, Gunicorn roda na porta 8000)
    gunicorn image_server:app
    ```

2.  **Terminal 2: Servidor do WhatsApp**
    (Este servidor ouve as mensagens do WhatsApp/Twilio)
    ```bash
    # (Por padr√£o, Gunicorn roda na porta 5000)
    gunicorn -b 0.0.0.0:5000 app:app
    ```

3.  **Terminal 3: Bot do Telegram**
    (Este script se conecta ao Telegram e busca mensagens)
    ```bash
    python bot_telegram.py
    ```

4.  **Terminal 4: Ngrok (Exposi√ß√£o dos Servidores)**
    Voc√™ precisar√° de **dois** t√∫neis Ngrok, um para cada servidor Flask:
    ```bash
    # T√∫nel para o Servidor de Imagens/MP (porta 8000)
    ngrok http 8000
    
    # Em outro terminal, o t√∫nel para o Servidor do WhatsApp (porta 5000)
    ngrok http 5000
    ```

### Configura√ß√£o Final dos Webhooks:

* **URL do Ngrok (porta 8000):** Pegue a URL `https://...` gerada pelo Ngrok (porta 8000) e cole-a na vari√°vel `BASE_URL` dentro dos arquivos `config.py` e `catalogo.py`.
* **URL do Ngrok (porta 5000):** Pegue a URL `https://...` gerada pelo Ngrok (porta 5000) e cole-a no painel da **Twilio**, na configura√ß√£o de webhook do seu n√∫mero de WhatsApp, adicionando `/whatsapp` no final (ex: `https://abcd-1234.ngrok-free.dev/whatsapp`).